{% extends "base.html" %} {% block title %}YouTube Summarizer{% endblock %} {%
block head %}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
/>
{% endblock %} {% block content %}
<div
    class="min-h-screen flex flex-col items-center justify-start pt-24 bg-gradient-to-br from-orange-50/60 via-white to-pink-50/60 p-4 font-[Inter] relative"
>
    <div class="text-center w-full max-w-2xl">
        <h1 class="text-4xl md:text-5xl font-semibold text-gray-900 mb-12">
            What can I help summarize?
        </h1>

        <form
            id="summarize-form"
            class="bg-white rounded-2xl p-4 shadow-sm border border-gray-200"
        >
            <div class="flex items-center gap-3">
                <input
                    type="url"
                    name="video_url"
                    id="video-url-input"
                    class="flex-1 bg-transparent border-none text-base py-3 px-3 outline-none text-gray-800 placeholder:text-gray-400"
                    placeholder="Paste a YouTube video URL..."
                    required
                    pattern=".*youtube\.com.*|.*youtu\.be.*"
                    title="Please enter a valid YouTube URL"
                />
                <button
                    type="submit"
                    id="submit-btn"
                    aria-label="Summarize"
                    class="bg-gradient-to-br from-amber-400 to-amber-500 border-none rounded-full w-11 h-11 flex items-center justify-center cursor-pointer transition-all duration-200 shadow-md shadow-amber-400/40 hover:scale-105 hover:shadow-lg hover:shadow-amber-400/50 active:scale-95"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        class="w-5 h-5 fill-gray-900"
                        id="submit-icon"
                    >
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        class="w-5 h-5 fill-gray-900 animate-spin hidden"
                        id="loading-icon"
                    >
                        <path
                            d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"
                            stroke="currentColor"
                            stroke-width="2"
                            fill="none"
                            stroke-linecap="round"
                        />
                    </svg>
                </button>
            </div>
        </form>

        <!-- Progress Timeline -->
        <div id="progress-timeline" class="hidden mt-8 w-full max-w-xl mx-auto">
            <div id="timeline-items" class="flex flex-col">
                <!-- Items will be inserted here dynamically -->
            </div>
        </div>

        <!-- Error Message -->
        <div
            id="error-message"
            class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm"
        ></div>

        <!-- Result Section -->
        <div id="result-section" class="hidden mt-8">
            <a id="video-link" href="#" target="_blank" class="block group">
                <div
                    class="relative rounded-xl overflow-hidden shadow-lg mb-4 transition-transform duration-200 group-hover:scale-[1.02]"
                >
                    <img
                        id="video-thumbnail"
                        src=""
                        alt="Video Thumbnail"
                        class="w-full aspect-video object-cover"
                    />
                    <div
                        class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            class="w-16 h-16 fill-white/90"
                        >
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </div>
                </div>
                <h2
                    id="video-title"
                    class="text-xl font-semibold text-gray-800 group-hover:text-amber-600 transition-colors duration-200 text-left mb-4"
                ></h2>
            </a>

            <div
                class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 text-left"
            >
                <h3
                    class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3"
                >
                    Summary
                </h3>
                <div
                    id="summary-content"
                    class="text-gray-700 leading-relaxed prose prose-sm max-w-none"
                ></div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeSlideIn {
        0% {
            opacity: 0;
            transform: translateY(-10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
        }
    }

    .timeline-item {
        animation: fadeSlideIn 0.4s ease-out forwards;
    }

    .timeline-dot-active {
        animation: pulse 1.5s ease-in-out infinite;
    }
</style>

<script>
    const form = document.getElementById("summarize-form");
    const submitBtn = document.getElementById("submit-btn");
    const submitIcon = document.getElementById("submit-icon");
    const loadingIcon = document.getElementById("loading-icon");
    const errorMessage = document.getElementById("error-message");
    const resultSection = document.getElementById("result-section");
    const videoLink = document.getElementById("video-link");
    const videoThumbnail = document.getElementById("video-thumbnail");
    const videoTitle = document.getElementById("video-title");
    const summaryContent = document.getElementById("summary-content");
    const progressTimeline = document.getElementById("progress-timeline");
    const timelineItems = document.getElementById("timeline-items");

    function addTimelineItem(message, type = "success") {
        const previousDots = timelineItems.querySelectorAll(
            ".timeline-dot-active"
        );
        previousDots.forEach((dot) => {
            dot.classList.remove("timeline-dot-active");
        });

        const item = document.createElement("div");
        item.className = "timeline-item flex items-center gap-3 mb-4 last:mb-0";

        const isError = type === "error";
        const dotColor = isError
            ? "bg-red-500 border-red-100"
            : "bg-emerald-500 border-emerald-100";
        const dotClass =
            !isError && type !== "complete" ? "timeline-dot-active" : "";
        const textColor = isError ? "text-red-600" : "text-emerald-700";

        item.innerHTML = `
            <div class="w-5 h-5 rounded-full border-4 flex-shrink-0 ${dotColor} ${dotClass}"></div>
            <p class="${textColor} font-medium text-sm pt-0.5">${message}</p>
        `;
        timelineItems.appendChild(item);
    }

    function clearTimeline() {
        timelineItems.innerHTML = "";
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Reset state
        errorMessage.classList.add("hidden");
        resultSection.classList.add("hidden");
        clearTimeline();
        progressTimeline.classList.remove("hidden");

        // Show loading state
        submitBtn.disabled = true;
        submitIcon.classList.add("hidden");
        loadingIcon.classList.remove("hidden");

        const formData = new FormData(form);

        try {
            // Use fetch with POST and read as event stream
            const response = await fetch("/api/summarize", {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "An error occurred");
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });

                // Process complete events in buffer
                const lines = buffer.split("\n");
                buffer = "";

                let currentEvent = null;
                let currentData = null;

                for (const line of lines) {
                    if (line.startsWith("event: ")) {
                        currentEvent = line.slice(7).trim();
                    } else if (line.startsWith("data: ")) {
                        currentData = line.slice(6);

                        if (currentEvent && currentData) {
                            try {
                                const data = JSON.parse(currentData);

                                if (currentEvent === "progress") {
                                    addTimelineItem(data.message);
                                } else if (currentEvent === "complete") {
                                    const activeDots =
                                        timelineItems.querySelectorAll(
                                            ".timeline-dot-active"
                                        );
                                    activeDots.forEach((dot) =>
                                        dot.classList.remove(
                                            "timeline-dot-active"
                                        )
                                    );

                                    // Hide timeline after a brief delay
                                    setTimeout(() => {
                                        progressTimeline.classList.add(
                                            "hidden"
                                        );
                                    }, 500);

                                    // Populate result
                                    const youtubeUrl = `https://www.youtube.com/watch?v=${data.video_id}`;
                                    videoLink.href = youtubeUrl;
                                    videoThumbnail.src = data.thumbnail;
                                    videoTitle.textContent = data.video_title;

                                    // Convert markdown-style bullets to HTML list
                                    const summaryLines = data.summary
                                        .split("\n")
                                        .filter((line) => line.trim());
                                    const formattedSummary = summaryLines
                                        .map((line) => {
                                            const cleanLine = line.replace(
                                                /^[\-\*â€¢]\s*/,
                                                ""
                                            );
                                            return `<li>${cleanLine}</li>`;
                                        })
                                        .join("");
                                    summaryContent.innerHTML = `<ul class="list-disc pl-5 space-y-2">${formattedSummary}</ul>`;

                                    resultSection.classList.remove("hidden");
                                } else if (currentEvent === "error") {
                                    addTimelineItem(data.error, "error");
                                    // Don't throw, just return to stop processing
                                    return;
                                }
                            } catch (parseError) {
                                if (parseError.message !== currentData) {
                                    buffer = line + "\n";
                                } else {
                                    throw parseError;
                                }
                            }
                            currentEvent = null;
                            currentData = null;
                        }
                    } else if (line.trim() === "") {
                        currentEvent = null;
                        currentData = null;
                    } else {
                        buffer += line + "\n";
                    }
                }
            }
        } catch (error) {
            progressTimeline.classList.add("hidden");
            errorMessage.textContent = error.message;
            errorMessage.classList.remove("hidden");
        } finally {
            submitBtn.disabled = false;
            submitIcon.classList.remove("hidden");
            loadingIcon.classList.add("hidden");
        }
    });
</script>
{% endblock %}
